import React, { useState } from 'react';
import { PersonalityReport, UserDetails } from '../types';
import { Button } from './Button';
import { Briefcase, Star, User, RefreshCw, Sparkles, Quote, Share2, Download, Check, Loader2, FileText, MessageSquare, Send } from 'lucide-react';
import { jsPDF } from 'jspdf';
import html2canvas from 'html2canvas';
import { dbService } from '../services/db';

interface ResultsProps {
  report: PersonalityReport;
  userDetails: UserDetails;
  onRetake: () => void;
  reportId: string | null;
  isReadOnly?: boolean;
  domId?: string;
}

export const Results: React.FC<ResultsProps> = ({ 
  report, 
  userDetails, 
  onRetake, 
  reportId,
  isReadOnly = false,
  domId = "report-content"
}) => {
  const [showCopied, setShowCopied] = useState(false);
  const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
  
  // Rating State
  const [rating, setRating] = useState(0);
  const [hoveredRating, setHoveredRating] = useState(0);
  const [feedback, setFeedback] = useState('');
  const [feedbackSubmitted, setFeedbackSubmitted] = useState(false);

  const safeFileName = `${userDetails.name}_PersonaPath`.replace(/[^a-z0-9]/gi, '_');

  const handleDownloadPDF = async () => {
    const element = document.getElementById(domId);
    if (!element) return;

    setIsGeneratingPdf(true);

    try {
      const canvas = await html2canvas(element, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        ignoreElements: (el) => el.hasAttribute('data-html2canvas-ignore'),
        logging: false
      });

      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 210;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      const pdf = new jsPDF({
        orientation: 'p',
        unit: 'mm',
        format: [imgWidth, imgHeight]
      });

      pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
      pdf.save(`${safeFileName}.pdf`);
    } catch (error) {
      console.error("PDF Generation failed:", error);
      alert("Could not generate PDF. Please try saving as text instead.");
    } finally {
      setIsGeneratingPdf(false);
    }
  };

  const handleDownloadText = () => {
    const textContent = `
PERSONA PATH AI - PERSONALITY REPORT
====================================
Name: ${userDetails.name}
Age: ${userDetails.age} | Gender: ${userDetails.gender}

PERSONALITY TYPE: ${report.personality_type.title}
${report.personality_type.description}

STRENGTHS
---------
${report.strengths.map(s => `• ${s.name}: ${s.description}`).join('\n')}

FICTIONAL MATCH
---------------
Character: ${report.fictional_match.character}
Universe: ${report.fictional_match.universe}
Why: ${report.fictional_match.reason}

SUGGESTED CAREER PATHS
----------------------
${report.career_suggestions.map(c => `• ${c.role}: ${c.why_fit}`).join('\n')}

------------------------------------
Generated by PersonaPath AI
`.trim();

    const blob = new Blob([textContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${safeFileName}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const handleShare = async () => {
    const shareData = {
      title: `${userDetails.name}'s PersonaPath Result`,
      text: `I discovered I'm a "${report.personality_type.title}" (Matches: ${report.fictional_match.character})! Check out PersonaPath AI.`,
      url: window.location.href
    };

    try {
      if (navigator.share && navigator.canShare(shareData)) {
        await navigator.share(shareData);
        return;
      }
      throw new Error("Web Share API not supported or failed");
    } catch (err) {
      console.log('Falling back to clipboard', err);
      try {
        await navigator.clipboard.writeText(`${shareData.text}\n${shareData.url}`);
        setShowCopied(true);
        setTimeout(() => setShowCopied(false), 2500);
      } catch (clipboardErr) {
        console.error('Clipboard failed', clipboardErr);
        alert('Could not share. Please manually copy the URL.');
      }
    }
  };

  const handleFeedbackSubmit = () => {
    if (reportId) {
      dbService.addFeedback(reportId, rating, feedback);
      console.log("Feedback saved to DB");
    } else {
      console.error("No Report ID found");
    }
    setFeedbackSubmitted(true);
  };

  return (
    <div 
      id={domId} 
      className="max-w-4xl mx-auto space-y-8 animate-fade-in pb-12 bg-white md:bg-transparent"
    >
      
      {/* Header / Hero */}
      <div className="bg-white rounded-3xl p-8 md:p-12 shadow-xl text-center border-t-8 border-indigo-500 relative overflow-hidden">
        <div className="absolute top-0 right-0 p-12 -mr-8 -mt-8 bg-gradient-to-br from-purple-100 to-transparent rounded-full opacity-50 blur-3xl w-64 h-64 pointer-events-none"></div>
        
        <div className="mb-4 text-gray-500 font-medium">
          Report for <span className="text-indigo-600 font-bold text-lg">{userDetails.name}</span>
        </div>

        <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-indigo-50 text-indigo-700 font-semibold text-sm mb-6 uppercase tracking-wider">
          <User className="w-4 h-4" /> Personality Type
        </div>
        <h1 className="text-4xl md:text-6xl font-bold text-gray-900 mb-4 tracking-tight">
          {report.personality_type.title}
        </h1>
        <p className="text-xl text-gray-600 max-w-2xl mx-auto leading-relaxed">
          {report.personality_type.description}
        </p>
      </div>

      <div className="grid md:grid-cols-2 gap-8">
        {/* Strengths */}
        <div className="bg-white rounded-3xl p-8 shadow-lg border border-gray-100">
          <div className="flex items-center gap-3 mb-6">
            <div className="p-3 bg-green-100 rounded-2xl text-green-600">
              <Star className="w-6 h-6" />
            </div>
            <h3 className="text-2xl font-bold text-gray-800">Your Strengths</h3>
          </div>
          <div className="space-y-4">
            {report.strengths.map((strength, idx) => (
              <div key={idx} className="p-4 bg-gray-50 rounded-xl border border-gray-100">
                <h4 className="font-bold text-gray-900 mb-1">{strength.name}</h4>
                <p className="text-sm text-gray-600 leading-snug">{strength.description}</p>
              </div>
            ))}
          </div>
        </div>

        {/* Fictional Match */}
        <div className="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-3xl p-8 shadow-xl text-white relative overflow-hidden flex flex-col justify-center">
          <div className="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -mr-16 -mt-16 blur-3xl"></div>
          
          <div className="relative z-10">
            <div className="flex items-center gap-2 text-indigo-200 font-medium mb-4 uppercase tracking-widest text-xs">
              <Sparkles className="w-4 h-4" /> Fictional Soulmate
            </div>
            <h3 className="text-3xl font-bold mb-1">{report.fictional_match.character}</h3>
            <p className="text-indigo-200 mb-6 font-medium italic">From {report.fictional_match.universe}</p>
            
            <div className="bg-white/10 backdrop-blur-md rounded-xl p-5 border border-white/20">
              <Quote className="w-8 h-8 text-indigo-300 mb-2 opacity-50" />
              <p className="text-indigo-50 leading-relaxed">
                {report.fictional_match.reason}
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* Career Suggestions */}
      <div className="bg-white rounded-3xl p-8 shadow-lg border border-gray-100">
        <div className="flex items-center gap-3 mb-8">
          <div className="p-3 bg-blue-100 rounded-2xl text-blue-600">
            <Briefcase className="w-6 h-6" />
          </div>
          <h3 className="text-2xl font-bold text-gray-800">Career Paths for You</h3>
        </div>
        
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {report.career_suggestions.map((career, idx) => (
            <div key={idx} className="group p-6 rounded-2xl border-2 border-gray-100 hover:border-blue-200 hover:bg-blue-50/50 transition-all duration-300">
              <h4 className="text-lg font-bold text-gray-900 mb-3 group-hover:text-blue-700 transition-colors">
                {career.role}
              </h4>
              <p className="text-sm text-gray-600 leading-relaxed">
                {career.why_fit}
              </p>
            </div>
          ))}
        </div>
      </div>

      {/* Rating Section - Hidden if readOnly */}
      {!isReadOnly && (
        <div data-html2canvas-ignore="true" className="bg-white rounded-3xl p-8 shadow-lg border border-gray-100 text-center">
          {!feedbackSubmitted ? (
            <>
              <h3 className="text-xl font-bold text-gray-900 mb-2">How accurate was this report?</h3>
              <p className="text-gray-500 text-sm mb-6">What you think your personalized report is right or not?</p>
              
              <div className="flex justify-center gap-2 mb-6">
                {[1, 2, 3, 4, 5].map((star) => (
                  <button
                    key={star}
                    onClick={() => setRating(star)}
                    onMouseEnter={() => setHoveredRating(star)}
                    onMouseLeave={() => setHoveredRating(0)}
                    className="transition-transform hover:scale-110 focus:outline-none"
                  >
                    <Star 
                      className={`w-8 h-8 ${
                        star <= (hoveredRating || rating) 
                          ? 'text-yellow-400 fill-yellow-400' 
                          : 'text-gray-300'
                      }`} 
                    />
                  </button>
                ))}
              </div>

              <div className="max-w-md mx-auto space-y-4">
                <div className="relative">
                  <div className="absolute top-3 left-3 text-gray-400">
                    <MessageSquare className="w-5 h-5" />
                  </div>
                  <textarea
                    value={feedback}
                    onChange={(e) => setFeedback(e.target.value)}
                    placeholder="Give details for changes if needed (Optional)..."
                    className="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 outline-none resize-none h-24 text-sm bg-white text-gray-900 placeholder:text-gray-400 appearance-none"
                  />
                </div>
                <Button 
                  onClick={handleFeedbackSubmit} 
                  disabled={rating === 0}
                  variant="primary"
                  className="w-full"
                >
                  Submit Feedback <Send className="w-4 h-4 ml-2" />
                </Button>
              </div>
            </>
          ) : (
            <div className="py-8 animate-fade-in">
              <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <Check className="w-8 h-8" />
              </div>
              <h3 className="text-xl font-bold text-gray-900">Thank you!</h3>
              <p className="text-gray-500">Your feedback helps us improve.</p>
            </div>
          )}
        </div>
      )}

      {/* Actions Bar - Hidden if readOnly */}
      {!isReadOnly && (
        <div 
          data-html2canvas-ignore="true" 
          className="flex flex-col md:flex-row justify-center items-center gap-4 pt-8 border-t border-gray-200 mt-12"
        >
          <Button onClick={onRetake} variant="secondary" className="px-8 w-full md:w-auto">
            <RefreshCw className="w-5 h-5" />
            Start Over
          </Button>
          
          <div className="flex gap-4 w-full md:w-auto">
            <Button 
              onClick={handleDownloadPDF} 
              variant="outline" 
              className="flex-1 md:flex-auto"
              disabled={isGeneratingPdf}
            >
              {isGeneratingPdf ? <Loader2 className="w-5 h-5 animate-spin" /> : <Download className="w-5 h-5" />}
              {isGeneratingPdf ? 'Generating...' : 'Download PDF'}
            </Button>
            
            <Button onClick={handleDownloadText} variant="outline" className="flex-1 md:flex-auto">
              <FileText className="w-5 h-5" />
              Save Text
            </Button>
            
            <Button onClick={handleShare} variant="primary" className="flex-1 md:flex-auto min-w-[120px]">
              {showCopied ? <Check className="w-5 h-5" /> : <Share2 className="w-5 h-5" />}
              {showCopied ? 'Copied!' : 'Share'}
            </Button>
          </div>
        </div>
      )}
    </div>
  );
};